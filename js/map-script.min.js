function enroute_initialize(){
	autocomplete = new google.maps.places.Autocomplete((document.getElementById('enroute-from')),{ types: ['geocode'] });
	google.maps.event.addListener(autocomplete, 'place_changed', function(){
		// Do something when the address is changed
	});

	Object.size = function(obj){
		var size = 0, key;
		for (key in obj) {
			if (obj.hasOwnProperty(key)) size++;
		}
		return size;
	};

	var stores = enr_pass.enr_map_locations;
	var stores_length = Object.size( stores );

	var pos = new google.maps.LatLng(-28.2161715, 25.2267369);
	var mapOptions = {
		zoom: 5,
		center: pos,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	};
	var map = new google.maps.Map(document.getElementById('enroute-map'), mapOptions);

	for( i = 0; i < stores_length; i++ ){

		var map_marker = 'marker_'+stores[i]['id'];
		var marker_name = stores[i]['name'];
		var marker_lat = stores[i]['gps']['lat'];
		var marker_lng = stores[i]['gps']['lng'];

		var marker_address = stores[i]['address'];
		var marker_email = stores[i]['email'];
		var marker_tel = stores[i]['tel'];

		map_marker = new google.maps.Marker({
			position: new google.maps.LatLng( marker_lat, marker_lng ),
			map: map,
			title: marker_name
		});

		attachInfoWindow( map_marker, marker_name, marker_address, marker_email, marker_tel );

	}

	var currentInfoWindow = null;

	function attachInfoWindow( map_marker, marker_name ){

		var infoWindowContent = '<h5>'+marker_name+'</h5>'+'<p>'+marker_address+'</p>'+'<p><a href="mailto:'+marker_email+'">'+marker_email+'</a><br>'+marker_tel+'</p>';

		var infowindow = new google.maps.InfoWindow({
			content: infoWindowContent
		});

		google.maps.event.addListener(map_marker, 'click', function(){
			if( currentInfoWindow != null ){ 
				currentInfoWindow.close();
			}
			infowindow.open( map, map_marker );
			currentInfoWindow = infowindow;
		});

	}
}
google.maps.event.addDomListener(window, 'load', enroute_initialize);

function enroute_geolocate(){
	if(navigator.geolocation){
		navigator.geolocation.getCurrentPosition(function(position){
			var geolocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
			autocomplete.setBounds(new google.maps.LatLngBounds(geolocation,geolocation));
		});
	}
}

function enroute_getmap(){
	var origin = document.getElementById('enroute-from').value;
	var destination = document.getElementById('enroute-to').value;
	var mainMap = document.getElementById('enroute-map');
	var mapHolder = document.getElementById('enroute-output');
	var dirHolder = document.getElementById('enroute-directions');

	if (origin == ''){
		document.getElementById('enroute-from').className = document.getElementById('enroute-from').className.replace( 'has-error', '' );
		document.getElementById('enroute-from').className = document.getElementById('enroute-from').className + ' has-error';
		return false;
	}

	if (destination == ''){
		document.getElementById('enroute-to').className = document.getElementById('enroute-from').className.replace( 'has-error', '' );
		document.getElementById('enroute-to').className = document.getElementById('enroute-from').className + ' has-error';
		return false;
	}

	var directionsService = new google.maps.DirectionsService();
	var directionsDisplay = new google.maps.DirectionsRenderer();

	mainMap.style.display = "none";
	mapHolder.style.display = "block";
	mapHolder.innerHTML = "";
	dirHolder.innerHTML = "";

	var map = new google.maps.Map(mapHolder, {
		zoom: 5,
		mapTypeId: google.maps.MapTypeId.ROADMAP
	});

	directionsDisplay.setMap(map);
	directionsDisplay.setPanel(dirHolder);

	var request = {
		origin: origin, 
		destination: destination,
		travelMode: google.maps.DirectionsTravelMode.DRIVING
	};

	directionsService.route(request, function(response, status){
		if (status == google.maps.DirectionsStatus.OK){
			dirHolder.style.display = "block";
			directionsDisplay.setDirections(response);
			document.getElementById('enroute-controls-top').style.display = "block";
			document.getElementById('enroute-controls-bottom').style.display = "block";
		} else {
			dirHolder.style.display = "none";
			document.getElementById('enroute-controls-top').style.display = "none";
			document.getElementById('enroute-controls-bottom').style.display = "none";
			document.getElementById('enroute-from').className = document.getElementById('enroute-from').className.replace( 'has-error', '' );
			document.getElementById('enroute-from').className = document.getElementById('enroute-from').className + ' has-error';
		}
	});
}

function enroute_printmap(){
	var header = '<html><head><title>Directions</title></head><body>';
	var content = document.getElementById('enroute-directions').innerHTML;
	var footer = '</body></html>';
	var old_content = document.body.innerHTML;
	document.body.innerHTML = header+content+footer;
	window.print();
	document.body.innerHTML = old_content;
	return false;
}

function enroute_clearoutput(){
	document.getElementById('enroute-from').value = "";
	document.getElementById('enroute-to').value = "";
	document.getElementById('enroute-map').style.display = "block";
	document.getElementById('enroute-output').innerHTML = "";
	document.getElementById('enroute-output').style.display = "none";
	document.getElementById('enroute-directions').innerHTML = "";
	document.getElementById('enroute-directions').style.display = "none";
	document.getElementById('enroute-controls-top').style.display = "none";
	document.getElementById('enroute-controls-bottom').style.display = "none";
}
